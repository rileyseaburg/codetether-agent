{
  "project": "codetether-agent",
  "feature": "A2A Ecosystem Worker Integration",
  "branch_name": "feature/a2a-worker-integration",
  "version": "1.0",
  "user_stories": [
    {
      "id": "US-001",
      "title": "Wire Session Execution in A2A Worker",
      "description": "Replace the TODO stub in handle_task() in src/a2a/worker.rs with actual session execution. The Session is already created and the prompt is already extracted — call session.prompt_with_events() to run the full agentic loop (LLM calls, tool execution, multi-turn). Collect the SessionResult and use its text as the task result sent back on release. Handle auto_approve policy by configuring the session's tool approval behavior accordingly.",
      "acceptance_criteria": [
        "handle_task() calls session.prompt_with_events() instead of logging a stub message",
        "SessionResult.text is sent as the task result in the release payload",
        "AutoApprove::All configures session for automatic tool approval",
        "AutoApprove::Safe configures session to auto-approve read-only tools only",
        "AutoApprove::None rejects tool calls that require approval (or skips them in headless mode)",
        "Errors from session.prompt_with_events() are caught and the task is released with status 'failed' and the error message",
        "cargo check passes with no new warnings"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-002",
      "title": "Stream Task Output to A2A Server",
      "description": "Forward SessionEvent variants from the prompt_with_events() event channel to the A2A server in real-time via POST /v1/opencode/tasks/{id}/output. Spawn a tokio task that reads from the mpsc::Receiver<SessionEvent> and POSTs output chunks (TextChunk, ToolCallStart, ToolCallComplete) to the server so the UI shows live progress. Include the worker_id and appropriate content-type headers.",
      "acceptance_criteria": [
        "A background tokio task consumes SessionEvent from the event channel",
        "SessionEvent::TextChunk sends accumulated text to POST /v1/opencode/tasks/{task_id}/output",
        "SessionEvent::ToolCallStart sends a structured update indicating which tool is running",
        "SessionEvent::ToolCallComplete sends tool output to the server",
        "SessionEvent::Error sends error information to the server",
        "Output streaming does not block or slow down the main session execution",
        "If the server is unreachable, output streaming logs a warning and continues without crashing",
        "Bearer token auth is included in output POST requests when configured"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": ["US-001"],
      "complexity": 3
    },
    {
      "id": "US-003",
      "title": "Implement Worker Heartbeat Loop",
      "description": "Add a periodic heartbeat loop that POSTs to /v1/opencode/workers/{worker_id}/heartbeat every 30 seconds to keep the worker registered as alive in the A2A server. Start the heartbeat as a background tokio task alongside the SSE stream connection. The heartbeat should include current status (idle, processing, number of active tasks). If the heartbeat fails 3 consecutive times, log an error but do not crash — the SSE reconnection loop will re-register.",
      "acceptance_criteria": [
        "A tokio::spawn task sends POST /v1/opencode/workers/{worker_id}/heartbeat every 30 seconds",
        "Heartbeat payload includes worker_id, agent_name, status (idle/processing), and active_task_count",
        "Heartbeat starts when the worker connects and stops when the worker shuts down",
        "3 consecutive heartbeat failures log an error but do not terminate the worker",
        "Heartbeat uses the same auth token as the SSE connection",
        "Heartbeat loop is cancelled and restarted on SSE reconnection"
      ],
      "passes": false,
      "priority": 2,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-004",
      "title": "Wire A2A Server message/send to Session Execution",
      "description": "Implement actual task processing in the A2A server's handle_message_send() in src/a2a/server.rs. When a message is received, spawn a background task that creates a Session, executes the prompt, updates the Task state through Submitted → Working → Completed/Failed, and stores the result as a Task Artifact. This enables codetether-agent to operate as a standalone A2A agent without needing the Python server.",
      "acceptance_criteria": [
        "handle_message_send() spawns a tokio task to process the message asynchronously",
        "Task state transitions: Submitted → Working (on start) → Completed (on success) or Failed (on error)",
        "Task status.timestamp is updated at each state transition",
        "Session result text is stored as an Artifact with type text/plain on the Task",
        "The Task in the DashMap is updated in-place so tasks/get reflects current state",
        "Concurrent message/send calls create independent tasks that execute in parallel",
        "Provider and model can be configured via server state or default to the configured provider"
      ],
      "passes": false,
      "priority": 2,
      "depends_on": ["US-001"],
      "complexity": 3
    },
    {
      "id": "US-005",
      "title": "Implement A2A Server message/stream Endpoint",
      "description": "Implement the handle_message_stream() handler in src/a2a/server.rs to return an SSE stream of task status updates and output chunks. Use axum's Sse response type to stream SessionEvent variants as JSON-encoded SSE events. The stream should emit task state transitions, text chunks, tool call events, and a final completion event.",
      "acceptance_criteria": [
        "handle_message_stream() returns an axum Sse response instead of an error",
        "SSE events include: task_status (state changes), text_chunk (partial output), tool_call (start/complete), done (completion)",
        "Each SSE event is a JSON object with 'type' and 'data' fields",
        "The stream closes after the task reaches a terminal state (Completed, Failed, Cancelled)",
        "Client disconnection does not leave orphaned background tasks",
        "The AgentCapabilities.streaming field is already set to true in default_card()"
      ],
      "passes": false,
      "priority": 3,
      "depends_on": ["US-004"],
      "complexity": 4
    },
    {
      "id": "US-006",
      "title": "Report Available Models to A2A Server on Registration",
      "description": "During worker registration in register_worker(), query the ProviderRegistry to discover all configured providers and their available models, then include this information in the registration payload sent to PUT /v1/worker/codebases. This lets the A2A server know what models the codetether-agent worker can use and enables intelligent task routing based on model availability.",
      "acceptance_criteria": [
        "register_worker() loads ProviderRegistry (from Vault or config) and calls list_models() on each provider",
        "Registration payload includes a 'models' field listing all available model identifiers grouped by provider",
        "Registration payload includes a 'capabilities' field listing agent features (ralph, swarm, rlm, a2a, mcp)",
        "If Vault is unreachable, registration proceeds without model info and logs a warning",
        "Models are re-reported on each SSE reconnection (since provider config may change)"
      ],
      "passes": false,
      "priority": 3,
      "depends_on": ["US-003"],
      "complexity": 3
    },
    {
      "id": "US-007",
      "title": "Task Status Updates During Execution",
      "description": "During task execution in handle_task(), send status updates to the A2A server as the task progresses through stages. Use PUT /v1/opencode/tasks/{id}/status to report transitions: claimed → working → streaming output → completed/failed. Include metadata about which provider/model is being used and a running tool call count.",
      "acceptance_criteria": [
        "After claiming, task status is updated to 'working' via PUT /v1/opencode/tasks/{id}/status",
        "Status payload includes provider name and model being used",
        "Status payload includes a tool_calls_count that increments as tools execute",
        "On completion, final status includes total tokens used (from SessionResult or session stats)",
        "On failure, status includes error message and partial output if available",
        "Status updates use the same auth token and error handling as other API calls"
      ],
      "passes": false,
      "priority": 2,
      "depends_on": ["US-001", "US-002"],
      "complexity": 2
    }
  ],
  "technical_requirements": [
    "All changes must pass cargo check, cargo clippy --all-features, and cargo test",
    "Use tracing for all logging (info for normal flow, warn for recoverable errors, error for failures)",
    "API keys must come from Vault — never hardcode or use env vars for secrets",
    "All HTTP requests to the A2A server must include bearer auth when token is configured",
    "Background tasks (heartbeat, output streaming) must be cancellable via tokio CancellationToken or JoinHandle abort",
    "Error handling must not panic — use anyhow::Result and log errors gracefully"
  ],
  "quality_checks": {
    "typecheck": "cargo check",
    "test": "cargo test",
    "lint": "cargo clippy --all-features",
    "build": "cargo build --release"
  },
  "created_at": "2026-02-06T00:00:00Z",
  "updated_at": "2026-02-06T00:00:00Z"
}